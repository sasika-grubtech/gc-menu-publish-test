name: Nightly Cypress Tests

on:
  push:
    branches:
      - master
      - main
  schedule:
    # Run at 8:00 PM UTC daily (equivalent to 0 20 * * * in CircleCI)
    - cron: '0 20 * * *'
  workflow_dispatch: # Allow manual triggering

env:
  NODE_VERSION: '20.17.0'
  CYPRESS_VERSION: '14.5.4'

jobs:
  build:
    name: Build and Install Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Install Cypress binary
        run: npx cypress install

      - name: Cache Cypress binary
        uses: actions/cache@v4
        with:
          path: ~/.cache/Cypress
          key: cypress-binary-${{ env.CYPRESS_VERSION }}

  run-tests-nightly:
    name: Run Cypress Tests
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 1440 # 24 hours max timeout
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Restore Cypress binary cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/Cypress
          key: cypress-binary-${{ env.CYPRESS_VERSION }}

      - name: Install dependencies
        run: npm install

      - name: Install Cypress binary
        run: npx cypress install

      - name: Create results directories
        run: |
          mkdir -p cypress/reports/mocha
          mkdir -p cypress/results

      - name: Run Cypress tests
        run: |
          export CI_BUILD_ID=${{ github.run_number }}
          export CIRCLE_BRANCH=${{ github.ref_name }}
          echo "Build ID: $CI_BUILD_ID"
          echo "Branch: $CIRCLE_BRANCH"
          echo "Launch Name: GC3 Automation - ${CIRCLE_BRANCH} - Build ${CI_BUILD_ID}"
          echo "Running all tests (no timeout limit - 24 hours max)"
          npm run cy:run:nightly || true
          echo "Test execution completed at $(date)"
          echo "Note: Build will continue even if tests fail - results will still be published"
        continue-on-error: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cypress-results
          path: |
            cypress/results
            cypress/reports/mocha
          retention-days: 30

  merge-report:
    name: Merge Reports and Publish to Report Portal
    needs: run-tests-nightly
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          name: cypress-results
          path: cypress/

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Merge JUnit test results
        run: npm run merge-junit-reports

      - name: Convert XML to uploadable structure
        run: npm run remove-xml-node

      - name: Verify XML file exists
        run: |
          if [ ! -f "cypress/results/gc3_publish-exection.xml" ]; then
            echo "Error: gc3_publish-exection.xml not found"
            exit 1
          fi
          echo "XML file found successfully"

      - name: Publish results to Report Portal
        run: |
          echo "Starting Report Portal upload at $(date)"
          
          # Get the Report Portal authentication token
          AUTH_TOKEN=$(curl --header "Content-Type: application/x-www-form-urlencoded" \
                    --request POST \
                    --data "grant_type=password&username=sasika&password=qzwMLp" \
                    --user "ui:uiman" \
                    https://report-portal.grubtech.com/uat/sso/oauth/token | jq -r '.access_token')
          
          if [ -z "$AUTH_TOKEN" ] || [ "$AUTH_TOKEN" = "null" ]; then
            echo "Error: Failed to obtain authentication token"
            exit 1
          fi
          
          echo "Authentication successful"
          
          # Make the POST API import results as a bulk to Report Portal using obtained token
          API_RESPONSE=$(curl -L -X POST 'https://report-portal.grubtech.com/api/v1/plugin/grubtech/junit/import' \
                    -H "Authorization: Bearer $AUTH_TOKEN" \
                    -F 'file=@"cypress/results/gc3_publish-exection.xml";type=application/xml')
          
          echo "Upload response: $API_RESPONSE"
          echo "Report Portal upload completed at $(date)"

      - name: Upload final results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: final-results
          path: cypress/results
          retention-days: 30

